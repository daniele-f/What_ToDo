(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const d of a)if(d.type==="childList")for(const i of d.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function t(a){const d={};return a.integrity&&(d.integrity=a.integrity),a.referrerPolicy&&(d.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?d.credentials="include":a.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function o(a){if(a.ep)return;a.ep=!0;const d=t(a);fetch(a.href,d)}})();function de(e){const n=new Date(e);return n.setHours(0,0,0,0),n}function ie(e){const n=new Date(e);n.setHours(0,0,0,0);const o=(n.getDay()+6)%7;return n.setDate(n.getDate()-o),n}function H(e){return e<10?`0${e}`:String(e)}function re(e){const n=H(e.getDate()),t=H(e.getMonth()+1),o=e.getFullYear(),a=H(e.getHours()),d=H(e.getMinutes());return`${n}/${t}/${o} ${a}:${d}`}function se(e,n){const t=Math.max(0,n.getTime()-e.getTime()),o=Math.floor(t/6e4),a=Math.floor(o/60),d=o%60;return`${a} hours ${d} minutes ago`}const R="todo-store-v1";let m=W(),T=!1,S=!1;const J=[];function C(){for(const e of J)e()}function ce(e){return J.push(e),()=>{const n=J.indexOf(e);n>=0&&J.splice(n,1)}}function y(){return new Date().toISOString()}function B(){return m}function V(e){for(const n of e.rows)n.type==="header"&&n.repeat!=="none"&&(n.repeat="none"),typeof n.indent!="number"||!isFinite(n.indent)||n.indent<0?n.indent=0:n.indent=Math.max(0,Math.floor(n.indent));return e}function W(){const e=localStorage.getItem(R);if(!e){const t={version:1,rows:[]};return localStorage.setItem(R,JSON.stringify(t)),t}try{const t=JSON.parse(e);if(t&&t.version===1&&Array.isArray(t.rows))return V(t)}catch{}const n={version:1,rows:[]};return localStorage.setItem(R,JSON.stringify(n)),n}function w(){if(T){S=!0;return}localStorage.setItem(R,JSON.stringify(m))}function D(){if(T){S=!0;return}m.lastEditedAt=y()}function Q(){m=W(),C()}function K(e=new Date){const n=de(e).getTime(),t=ie(e).getTime();let o=!1;for(const a of m.rows){if(a.type!=="todo"||!a.done||!a.lastCompletedAt)continue;const d=new Date(a.lastCompletedAt).getTime();a.repeat==="daily"?d<n&&(a.done=!1,a.updatedAt=y(),o=!0):a.repeat==="weekly"&&d<t&&(a.done=!1,a.updatedAt=y(),o=!0)}return Z()&&(o=!0),o&&(w(),C()),o}function le(e,n,t){const o=crypto.randomUUID(),a=y(),d={id:o,type:e,text:n.trim(),indent:0,repeat:e==="header"?"none":t,done:!1,createdAt:a,updatedAt:a};return m.rows.push(d),D(),w(),C(),d}function X(e,n){const t=m.rows.find(a=>a.id===e);if(!t)return;const o=n.trim();o.length!==0&&(t.text=o,t.updatedAt=y(),D(),w(),C())}function ue(e,n){const t=m.rows.find(o=>o.id===e);if(t){if(t.type==="header"){t.repeat!=="none"&&(t.repeat="none",t.updatedAt=y(),D(),w(),C());return}t.repeat=n,t.updatedAt=y(),D(),w(),C()}}function F(e,n){const t=m.rows.find(a=>a.id===e);if(!t)return;const o=Math.max(0,Math.floor((t.indent??0)+n));o!==t.indent&&(t.indent=o,t.updatedAt=y(),Z(),D(),w(),C())}function P(e){var o;const n=((o=m.rows[e])==null?void 0:o.indent)??0;let t=e+1;for(;t<m.rows.length&&(m.rows[t].indent??0)>n;)t++;return t}function fe(e,n,t){const o=P(e);for(let a=e+1;a<o;a++){const d=m.rows[a];d.type==="todo"&&d.done!==n&&(d.done=n,n?d.lastCompletedAt=t:delete d.lastCompletedAt,d.updatedAt=t)}}function Z(){let e=!1;const n=y();for(let t=0;t<m.rows.length;t++){const o=m.rows[t];if(o.type!=="todo")continue;const a=P(t);let d=!1,i=!0;for(let h=t+1;h<a;h++){const v=m.rows[h];if(v.type==="todo"&&(d=!0,!v.done)){i=!1;break}}d&&o.done!==i&&(o.done=i,i?o.lastCompletedAt=n:delete o.lastCompletedAt,o.updatedAt=n,e=!0)}return e}function pe(e){var a;let n=!1,t=((a=m.rows[e])==null?void 0:a.indent)??0;const o=y();for(let d=e-1;d>=0;){for(;d>=0&&m.rows[d].indent>=t;)d--;if(d<0)break;const i=m.rows[d],h=P(d);let v=!1,s=!0;for(let r=d+1;r<h;r++){const c=m.rows[r];if(c.type==="todo"&&(v=!0,!c.done)){s=!1;break}}i.type==="todo"&&v&&i.done!==s&&(i.done=s,s?i.lastCompletedAt=o:delete i.lastCompletedAt,i.updatedAt=o,n=!0),t=i.indent,d--}return n}function me(e,n){const t=m.rows.findIndex(d=>d.id===e&&d.type==="todo");if(t===-1)return;const o=m.rows[t],a=y();o.done=n,n?o.lastCompletedAt=a:delete o.lastCompletedAt,o.updatedAt=a,fe(t,n,a),pe(t),D(),w(),C()}function ee(e){const n=m.rows.findIndex(t=>t.id===e);n!==-1&&(m.rows.splice(n,1),D(),w(),C())}function he(){return JSON.stringify(m,null,2)}function ge(e){try{const n=JSON.parse(e);if(!n||n.version!==1||!Array.isArray(n.rows))return!1;for(const t of n.rows)if(!t.id||!t.type||typeof t.text!="string"||t.type!=="header"&&t.type!=="todo"||t.repeat!=="none"&&t.repeat!=="daily"&&t.repeat!=="weekly")return!1;return m=V(n),w(),C(),!0}catch{return!1}}function be(e){T=e}function Ee(){if(!S){T=!1;return}m.lastEditedAt=y(),T=!1,S=!1,w(),C()}function ve(){Q(),S=!1}function z(){return S}function xe(e,n){const t=m.rows.findIndex(v=>v.id===e);if(t===-1)return;const o=P(t),a=o-t,d=m.rows.length;let i=Math.max(0,Math.min(d,n));if(i>t&&i<=o)return;const h=m.rows.splice(t,a);t<i&&(i-=a),m.rows.splice(i,0,...h),D(),w(),C()}function Ce(e){const n=document.createElement("div");n.className="controls";const t=document.createElement("select");t.setAttribute("aria-label","Row type");const o=document.createElement("option");o.value="header",o.textContent="Header";const a=document.createElement("option");a.value="todo",a.textContent="Todo",t.appendChild(a),t.appendChild(o);const d=document.createElement("input");d.type="text",d.placeholder="Text...",d.setAttribute("aria-label","Row text");const i=document.createElement("select");i.setAttribute("aria-label","Repeat");for(const u of["daily","weekly","none"]){const l=document.createElement("option");l.value=u,l.textContent=u,i.appendChild(l)}function h(){const u=t.value==="header";i.value=u?"none":i.value||"none",i.disabled=u}t.addEventListener("change",h),h();function v(){var p;const u=t.value,l=d.value.trim(),f=i.value;l&&((p=e.onBeforeMutate)==null||p.call(e),le(u,l,f),d.value="",d.focus())}const s=document.createElement("button");s.textContent="Add",s.setAttribute("aria-label","Add new row"),s.addEventListener("click",()=>v()),d.addEventListener("keydown",u=>{u.key==="Enter"&&(u.preventDefault(),v())});const r=document.createElement("button");r.className="secondary",r.textContent="Export JSON",r.setAttribute("aria-label","Export data as JSON"),r.addEventListener("click",()=>{const u=he(),l=new Blob([u],{type:"application/json"}),f=URL.createObjectURL(l),p=document.createElement("a");p.href=f,p.download="todo-store-v1.json",document.body.appendChild(p),p.click(),p.remove(),URL.revokeObjectURL(f)});const c=document.createElement("button");c.className="secondary",c.textContent="Import JSON",c.setAttribute("aria-label","Import data from JSON");const g=document.createElement("input");return g.type="file",g.accept=".json,application/json",g.classList.add("hidden"),g.addEventListener("change",()=>{var f;const u=(f=g.files)==null?void 0:f[0];if(!u)return;const l=new FileReader;l.onload=()=>{var E;const p=String(l.result??"");if(!p||!confirm("Import will replace current data. Continue?"))return;(E=e.onBeforeMutate)==null||E.call(e),ge(p)||alert("Invalid JSON format.")},l.readAsText(u),g.value=""}),c.addEventListener("click",()=>g.click()),n.appendChild(t),n.appendChild(d),n.appendChild(i),n.appendChild(s),n.appendChild(r),n.appendChild(c),n.appendChild(g),n}function ye(e){const n="drop-before",t="drop-after",o="drop-invalid";let a=null;function d(i,h){const v=i.querySelector(".drag-handle");function s(r){i.setAttribute("draggable",r?"true":"false")}if(s(!1),v){const r=g=>s(!0),c=()=>s(!1);v.addEventListener("mousedown",r),v.addEventListener("touchstart",r,{passive:!0}),document.addEventListener("mouseup",c),document.addEventListener("touchend",c),document.addEventListener("touchcancel",c)}else s(!1);i.addEventListener("dragstart",r=>{var c;if(i.getAttribute("draggable")!=="true"){try{r.preventDefault()}catch{}return}a=h,i.classList.add("dragging");try{(c=r.dataTransfer)==null||c.setData("text/plain",h)}catch{}r.dataTransfer&&(r.dataTransfer.effectAllowed="move")}),i.addEventListener("dragend",()=>{i.classList.remove("dragging"),i.classList.remove(n,t,o),a=null,s(!1)}),i.addEventListener("dragover",r=>{var b;if(!a)return;r.preventDefault();const c=i.getBoundingClientRect(),g=r.clientY-c.top<c.height/2;i.classList.toggle(n,g),i.classList.toggle(t,!g);const u=B(),l=u.rows.findIndex(E=>E.id===a),f=u.rows.findIndex(E=>E.id===h);let p=!1;if(l!==-1&&f!==-1){const E=((b=u.rows[l])==null?void 0:b.indent)??0;let L=l+1;for(;L<u.rows.length&&(u.rows[L].indent??0)>E;)L++;const I=L,N=g?f:f+1;p=N>l&&N<=I}i.classList.toggle(o,p),r.dataTransfer&&(r.dataTransfer.dropEffect="move")}),i.addEventListener("dragleave",()=>{i.classList.remove(n,t,o)}),i.addEventListener("drop",r=>{var N,O;if(!a)return;r.preventDefault(),i.classList.remove(n,t,o);const c=i.getBoundingClientRect(),g=r.clientY-c.top<c.height/2,u=B(),l=u.rows.findIndex(x=>x.id===a),f=u.rows.findIndex(x=>x.id===h);if(l===-1||f===-1)return;const p=g?f:f+1,b=((N=u.rows[l])==null?void 0:N.indent)??0;let E=l+1;for(;E<u.rows.length&&(u.rows[E].indent??0)>b;)E++;const L=E;p>l&&p<=L||p===l||((O=e.onBeforeMutate)==null||O.call(e),xe(a,p))})}return{enableRowDrag:d}}function _(e,n){const{mode:t,opts:o,enableRowDrag:a}=n,d=document.createElement("div");d.className="row-line";const i=document.createElement("div");i.className="row header",i.style.marginLeft=`${e.indent?e.indent*24:0}px`;const h=document.createElement("div");if(h.textContent=e.text,i.appendChild(h),t==="edit"){const v=document.createElement("div");v.className="indent-group";const s=document.createElement("button");s.className="icon icon-left",s.textContent="<",s.title="Outdent (Shift+Tab)",s.setAttribute("aria-label",`Outdent header: ${e.text}`),s.disabled=(e.indent??0)===0,s.addEventListener("click",()=>{var f;(f=o.onBeforeMutate)==null||f.call(o),F(e.id,-1)});const r=document.createElement("button");r.className="icon icon-right",r.textContent=">",r.title="Indent (Tab)",r.setAttribute("aria-label",`Indent header: ${e.text}`),r.addEventListener("click",()=>{var f;(f=o.onBeforeMutate)==null||f.call(o),F(e.id,1)}),v.appendChild(s),v.appendChild(r),d.appendChild(v);const c=document.createElement("div");c.className="drag-handle",c.title="Drag to reorder",c.setAttribute("aria-label",`Drag to reorder: ${e.text}`),c.textContent="☰",d.appendChild(c);const g=document.createElement("div");g.className="actions";const u=document.createElement("button");u.className="secondary",u.textContent="Edit",u.setAttribute("aria-label",`Edit header: ${e.text}`),u.addEventListener("click",()=>{var p;const f=prompt("Edit header text:",e.text);if(f!=null){const b=f.trim();b&&((p=o.onBeforeMutate)==null||p.call(o),X(e.id,b))}});const l=document.createElement("button");l.className="icon danger",l.textContent="🗑︎",l.title="Delete",l.setAttribute("aria-label",`Delete header: ${e.text}`),l.addEventListener("click",()=>{var f;confirm("Delete this header?")&&((f=o.onBeforeMutate)==null||f.call(o),ee(e.id))}),g.appendChild(u),g.appendChild(l),i.appendChild(g),a(d,e.id)}return d.appendChild(i),d}function Y(e,n){const{mode:t,opts:o,enableRowDrag:a}=n,d=document.createElement("div");d.className="row-line";const i=document.createElement("div");if(i.className="row todo",i.style.marginLeft=`${e.indent?e.indent*24:0}px`,t==="read"){const s=document.createElement("input");s.type="checkbox",s.className="checkbox",s.checked=e.done,s.setAttribute("aria-label",`Toggle todo: ${e.text}`),s.addEventListener("change",()=>{var r;(r=o.onBeforeMutate)==null||r.call(o),me(e.id,s.checked)}),i.appendChild(s)}else{const s=document.createElement("div");s.className="checkbox-spacer",i.appendChild(s)}const h=document.createElement("div");h.className="text";const v=document.createElement("span");if(v.textContent=e.text,h.appendChild(v),e.repeat!=="none"){const s=document.createElement("span");s.className=`badge ${e.repeat}`,s.textContent=e.repeat,s.setAttribute("aria-label",`Repeat: ${e.repeat}`),h.appendChild(s)}if(i.appendChild(h),t==="edit"){const s=document.createElement("div");s.className="indent-group";const r=document.createElement("button");r.className="icon icon-left",r.textContent="<",r.title="Outdent (Shift+Tab)",r.setAttribute("aria-label",`Outdent todo: ${e.text}`),r.disabled=(e.indent??0)===0,r.addEventListener("click",()=>{var b;(b=o.onBeforeMutate)==null||b.call(o),F(e.id,-1)});const c=document.createElement("button");c.className="icon icon-right",c.textContent=">",c.title="Indent (Tab)",c.setAttribute("aria-label",`Indent todo: ${e.text}`),c.addEventListener("click",()=>{var b;(b=o.onBeforeMutate)==null||b.call(o),F(e.id,1)}),s.appendChild(r),s.appendChild(c),d.appendChild(s);const g=document.createElement("div");g.className="drag-handle",g.title="Drag to reorder",g.setAttribute("aria-label",`Drag to reorder: ${e.text}`),g.textContent="☰",d.appendChild(g);const u=document.createElement("div");u.className="actions";const l=document.createElement("select");for(const b of["none","daily","weekly"]){const E=document.createElement("option");E.value=b,E.textContent=b,b===e.repeat&&(E.selected=!0),l.appendChild(E)}l.setAttribute("aria-label",`Change repeat for: ${e.text}`),l.addEventListener("change",()=>{var E;const b=l.value;(E=o.onBeforeMutate)==null||E.call(o),ue(e.id,b)});const f=document.createElement("button");f.className="secondary",f.textContent="Edit",f.setAttribute("aria-label",`Edit todo: ${e.text}`),f.addEventListener("click",()=>{var E;const b=prompt("Edit todo text:",e.text);if(b!=null){const L=b.trim();L&&((E=o.onBeforeMutate)==null||E.call(o),X(e.id,L))}});const p=document.createElement("button");p.className="icon danger",p.textContent="🗑︎",p.title="Delete",p.setAttribute("aria-label",`Delete todo: ${e.text}`),p.addEventListener("click",()=>{var b;confirm("Delete this todo?")&&((b=o.onBeforeMutate)==null||b.call(o),ee(e.id))}),u.appendChild(l),u.appendChild(f),u.appendChild(p),i.appendChild(u),a(d,e.id)}else{const s=document.createElement("div");i.appendChild(s)}return d.appendChild(i),d}function Le(){const e=B(),n=document.getElementById("last-edited");if(!n)return;const t=e.lastEditedAt?re(new Date(e.lastEditedAt)):"Never",o=e.lastEditedAt?` (${se(new Date(e.lastEditedAt),new Date)})`:"";n.textContent=`Last edited at: ${t}${o}`}function Ae(e,n={}){let t="read";function o(){e.innerHTML="",t==="edit"?e.classList.add("mode-edit"):e.classList.remove("mode-edit");const a=document.createElement("div");a.className="topbar";const d=document.createElement("div");d.className="left";const i=document.createElement("div");i.className="right";const h=document.createElement("button");if(h.className="secondary",h.setAttribute("aria-label","Toggle edit mode"),(()=>{t==="read"?h.textContent="Edit mode":h.textContent=z()?"Save Changes":"Exit Edit Mode"})(),h.addEventListener("click",()=>{t==="read"?(be(!0),t="edit"):(Ee(),t="read"),o()}),t==="edit"){const r=document.createElement("button");r.className="secondary",r.textContent="Undo",r.setAttribute("aria-label","Undo changes since entering edit mode"),r.disabled=!z(),r.addEventListener("click",()=>{r.disabled||(ve(),o())}),i.appendChild(r)}i.appendChild(h),a.appendChild(d),a.appendChild(i);const s=document.createElement("div");if(s.className="card",t==="edit"&&s.appendChild(Ce(n)),B().rows.length===0){const r=document.createElement("div");r.className="empty",r.textContent="No items yet. Toggle Edit mode to add headers and todos.",s.appendChild(r)}else{const r=document.createElement("div");r.className="list";const c=B().rows,{enableRowDrag:g}=ye(n),u={mode:t,opts:n,enableRowDrag:g};for(let l=0;l<c.length;l++){const f=c[l],p=f.indent?f.indent:0,b=l>0&&c[l-1].indent?c[l-1].indent:0,E=l<c.length-1&&c[l+1].indent?c[l+1].indent:0,L=E>p,I=p>0,N=I&&b<p,O=I&&E<p;if(L){const x=document.createElement("div");x.className="group-block",x.style.marginLeft=`${p?p*24:0}px`;const U=f.type==="header"?_(f,u):Y(f,u);U.classList.add("group-parent");const G=U.querySelector(".row");G&&(G.style.marginLeft="0px"),x.appendChild(U);let A=l+1;for(;A<c.length&&(c[A].indent?c[A].indent:0)>p;){const k=c[A],$=k.indent?k.indent:0,te=c[A-1].indent?c[A-1].indent:0,ne=A<c.length-1&&c[A+1].indent?c[A+1].indent:0,j=$>0,oe=j&&te<$,ae=j&&ne<$,M=k.type==="header"?_(k,u):Y(k,u);j&&M.classList.add("group-child"),oe&&M.classList.add("group-first"),ae&&M.classList.add("group-last");const q=M.querySelector(".row");q&&(q.style.marginLeft=`${($-p)*24}px`),x.appendChild(M),A++}r.appendChild(x),l=A-1}else{const x=f.type==="header"?_(f,u):Y(f,u);I&&x.classList.add("group-child"),N&&x.classList.add("group-first"),O&&x.classList.add("group-last"),r.appendChild(x)}}s.appendChild(r)}e.appendChild(a),e.appendChild(s)}return{render:o,updateRelativeTimer:Le}}window.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("app");if(!e)return;let n=!1;const t=Ae(e,{onBeforeMutate:()=>{n&&(K(new Date),n=!1)}});K(new Date),t.render(),ce(()=>t.render()),window.addEventListener("storage",a=>{a.key===R&&Q()});let o=Date.now();setInterval(()=>{const a=Date.now();a-o>6*60*60*1e3&&(n=!0),o=a,t.updateRelativeTimer()},6e4)});
